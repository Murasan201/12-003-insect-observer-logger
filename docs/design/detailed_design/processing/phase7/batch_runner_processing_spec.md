# batch_runner.py å‡¦ç†èª¬æ˜æ›¸

**æ–‡æ›¸ç•ªå·**: 12-002-PROC-013  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: æ˜†è™«è‡ªå‹•è¦³å¯Ÿï¼†ãƒ­ã‚°è¨˜éŒ²ã‚¢ãƒ—ãƒª  
**æ–‡æ›¸å**: batch_runner.py å‡¦ç†èª¬æ˜æ›¸  
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `batch_runner.py`  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆæ—¥**: 2025-07-29  
**ä½œæˆè€…**: é–‹ç™ºãƒãƒ¼ãƒ   

---

## ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«æ¦‚è¦

### ç›®çš„
cronã‚„ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‹ã‚‰ã®å®šæœŸå®Ÿè¡Œã€ãƒãƒƒãƒå‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå‹•åŒ–ãƒ»é‹ç”¨ç®¡ç†ã‚’å®Ÿç¾ã™ã‚‹ã€‚

### ä¸»è¦æ©Ÿèƒ½
- å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼ˆé–“éš”ãƒ»æ—¥æ¬¡ãƒ»é€±æ¬¡å®Ÿè¡Œï¼‰
- è¤‡æ•°ã‚¸ãƒ§ãƒ–ã®ä¸¦åˆ—å®Ÿè¡Œãƒ»ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ç®¡ç†
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
- å®Ÿè¡Œãƒ­ã‚°è¨˜éŒ²ãƒ»çµæœè¿½è·¡ãƒ»é€šçŸ¥æ©Ÿèƒ½
- CLI ãƒ™ãƒ¼ã‚¹ã®ã‚¸ãƒ§ãƒ–ç®¡ç†ãƒ»è¨­å®šå¤‰æ›´
- cronçµ±åˆãƒ»å¤–éƒ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©é€£æº

---

## ğŸ”§ é–¢æ•°ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ä»•æ§˜

### BatchRunner.__init__(config_path)

**æ¦‚è¦**: ãƒãƒƒãƒå‡¦ç†å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–

**å‡¦ç†å†…å®¹**:
1. ãƒ­ã‚¬ãƒ¼è¨­å®šãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ä¿å­˜
2. ã‚¸ãƒ§ãƒ–è¾æ›¸ãƒ»å®Ÿè¡ŒçŠ¶æ…‹ãƒ•ãƒ©ã‚°ã®åˆæœŸåŒ–
3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰ç®¡ç†ã®åˆæœŸåŒ–
4. ã‚¸ãƒ§ãƒ–è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆ_load_job_configï¼‰
5. ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®šï¼ˆSIGINT, SIGTERMï¼‰

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def __init__(self, config_path: str = "./config/batch_config.json"):
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| config_path | str | Ã— | ãƒãƒƒãƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: batch_config.jsonï¼‰ |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆæœŸåŒ– |

---

### _load_job_config()

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–è¨­å®šèª­ã¿è¾¼ã¿

**å‡¦ç†å†…å®¹**:
1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªãƒ»JSONèª­ã¿è¾¼ã¿
2. ã‚¸ãƒ§ãƒ–ãƒ‡ãƒ¼ã‚¿ã®è§£æãƒ»BatchJobã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
3. ã‚¸ãƒ§ãƒ–è¾æ›¸ã¸ã®ç™»éŒ²ãƒ»ãƒ­ã‚°å‡ºåŠ›
4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æœªå­˜åœ¨æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šä½œæˆ

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def _load_job_config(self) -> None:
```

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | è¨­å®šèª­ã¿è¾¼ã¿å®Œäº† |

---

### _create_default_config()

**æ¦‚è¦**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šä½œæˆ

**å‡¦ç†å†…å®¹**:
1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆã®å®šç¾©
2. è¨­å®šè¾æ›¸ã®ä½œæˆãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
3. JSONå½¢å¼ã§ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
4. è¨­å®šå†èª­ã¿è¾¼ã¿ï¼ˆ_load_job_configï¼‰

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¸ãƒ§ãƒ–**:
- `hourly_detection`: 1æ™‚é–“ã”ã¨ã®æ¤œå‡ºå®Ÿè¡Œ
- `daily_analysis`: æ·±å¤œ2æ™‚ã®æ—¥æ¬¡åˆ†æ
- `weekly_cleanup`: æ—¥æ›œæ—¥ã®é€±æ¬¡ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- `daily_backup`: æ·±å¤œ3æ™‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆç„¡åŠ¹ï¼‰

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def _create_default_config(self) -> None:
```

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šä½œæˆå®Œäº† |

---

### add_job(job)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–è¿½åŠ 

**å‡¦ç†å†…å®¹**:
1. ã‚¸ãƒ§ãƒ–è¾æ›¸ã¸ã®è¿½åŠ ãƒ»è¨­å®šä¿å­˜
2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼å‹•ä½œä¸­æ™‚ã®å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
3. è¿½åŠ å®Œäº†ãƒ­ã‚°ã®å‡ºåŠ›

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def add_job(self, job: BatchJob) -> None:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job | BatchJob | â—‹ | è¿½åŠ ã™ã‚‹ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | ã‚¸ãƒ§ãƒ–è¿½åŠ å®Œäº† |

**ä½¿ç”¨ä¾‹**:
```python
new_job = BatchJob(
    name="custom_task",
    command="python custom_script.py",
    schedule_type="daily",
    schedule_time="12:00"
)
runner.add_job(new_job)
```

---

### remove_job(job_name)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–å‰Šé™¤

**å‡¦ç†å†…å®¹**:
1. ã‚¸ãƒ§ãƒ–å­˜åœ¨ç¢ºèªãƒ»è¾æ›¸ã‹ã‚‰ã®å‰Šé™¤
2. è¨­å®šä¿å­˜ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã®å‰Šé™¤
3. å‰Šé™¤çµæœã®è¿”å´ãƒ»ãƒ­ã‚°å‡ºåŠ›

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def remove_job(self, job_name: str) -> bool:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job_name | str | â—‹ | å‰Šé™¤å¯¾è±¡ã‚¸ãƒ§ãƒ–å |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| success | bool | å‰Šé™¤æˆåŠŸå¯å¦ |

---

### enable_job(job_name, enabled)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–æœ‰åŠ¹/ç„¡åŠ¹åŒ–

**å‡¦ç†å†…å®¹**:
1. ã‚¸ãƒ§ãƒ–å­˜åœ¨ç¢ºèªãƒ»æœ‰åŠ¹ãƒ•ãƒ©ã‚°ã®æ›´æ–°
2. è¨­å®šä¿å­˜ãƒ»æœ‰åŠ¹æ™‚ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
3. ç„¡åŠ¹æ™‚ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤
4. çŠ¶æ…‹å¤‰æ›´çµæœã®è¿”å´ãƒ»ãƒ­ã‚°å‡ºåŠ›

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def enable_job(self, job_name: str, enabled: bool = True) -> bool:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job_name | str | â—‹ | å¯¾è±¡ã‚¸ãƒ§ãƒ–å |
| enabled | bool | Ã— | æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Trueï¼‰ |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| success | bool | çŠ¶æ…‹å¤‰æ›´æˆåŠŸå¯å¦ |

---

### _setup_job_schedule(job)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š

**å‡¦ç†å†…å®¹**:
1. ã‚¸ãƒ§ãƒ–æœ‰åŠ¹æ€§ç¢ºèªãƒ»æ—¢å­˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¯ãƒªã‚¢
2. ã‚¸ãƒ§ãƒ–å®Ÿè¡Œé–¢æ•°ã®å®šç¾©ï¼ˆlambdaï¼‰
3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã®è¨­å®šï¼š
   - interval: ç§’é–“éš”ã§ã®å®Ÿè¡Œ
   - daily: æŒ‡å®šæ™‚åˆ»ã§ã®æ—¥æ¬¡å®Ÿè¡Œ
   - weekly: æŒ‡å®šæ›œæ—¥ã§ã®é€±æ¬¡å®Ÿè¡Œ
4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ãƒ»ãƒ­ã‚°å‡ºåŠ›

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def _setup_job_schedule(self, job: BatchJob) -> None:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job | BatchJob | â—‹ | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šå¯¾è±¡ã‚¸ãƒ§ãƒ– |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šå®Œäº† |

---

### _run_job(job)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ

**å‡¦ç†å†…å®¹**:
1. å®Ÿè¡Œé–‹å§‹æ™‚åˆ»è¨˜éŒ²ãƒ»BatchResultåˆæœŸåŒ–
2. subprocess ã«ã‚ˆã‚‹ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ30åˆ†ï¼‰
3. å®Ÿè¡Œçµæœã®åˆ¤å®šï¼ˆæˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
4. ã‚¸ãƒ§ãƒ–çŠ¶æ…‹æ›´æ–°ãƒ»è¨­å®šä¿å­˜
5. å®Ÿè¡Œçµæœè¨˜éŒ²ãƒ»ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆ3å›é€£ç¶šå¤±æ•—æ™‚ï¼‰

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def _run_job(self, job: BatchJob) -> BatchResult:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job | BatchJob | â—‹ | å®Ÿè¡Œå¯¾è±¡ã‚¸ãƒ§ãƒ– |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| result | BatchResult | ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæœ |

**å®Ÿè¡ŒçŠ¶æ…‹**:
- `running`: å®Ÿè¡Œä¸­
- `success`: å®Ÿè¡ŒæˆåŠŸ
- `error`: å®Ÿè¡Œã‚¨ãƒ©ãƒ¼
- `timeout`: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

---

### run_scheduler()

**æ¦‚è¦**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œ

**å‡¦ç†å†…å®¹**:
1. å®Ÿè¡Œãƒ•ãƒ©ã‚°è¨­å®šãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼é–‹å§‹ãƒ­ã‚°
2. å…¨ã‚¸ãƒ§ãƒ–ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—ï¼ˆ1ç§’é–“éš”ã§ã®run_pendingï¼‰
4. ä¾‹å¤–å‡¦ç†ãƒ»çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def run_scheduler(self) -> None:
```

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼çµ‚äº†æ™‚ |

**ä½¿ç”¨ä¾‹**:
```python
runner = BatchRunner()
runner.run_scheduler()  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼é–‹å§‹ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
```

---

### run_job_immediately(job_name)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–å³æ™‚å®Ÿè¡Œ

**å‡¦ç†å†…å®¹**:
1. ã‚¸ãƒ§ãƒ–å­˜åœ¨ç¢ºèªãƒ»ã‚¨ãƒ©ãƒ¼æ™‚ã®Noneè¿”å´
2. ã‚¸ãƒ§ãƒ–å®Ÿè¡Œï¼ˆ_run_jobï¼‰ãƒ»çµæœè¿”å´

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def run_job_immediately(self, job_name: str) -> Optional[BatchResult]:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job_name | str | â—‹ | å®Ÿè¡Œå¯¾è±¡ã‚¸ãƒ§ãƒ–å |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| result | Optional[BatchResult] | å®Ÿè¡Œçµæœï¼ˆã‚¸ãƒ§ãƒ–ãªã—æ™‚Noneï¼‰ |

**ä½¿ç”¨ä¾‹**:
```python
result = runner.run_job_immediately("daily_analysis")
if result and result.status == "success":
    print("åˆ†æãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ")
```

---

### get_job_status()

**æ¦‚è¦**: å…¨ã‚¸ãƒ§ãƒ–çŠ¶æ…‹å–å¾—

**å‡¦ç†å†…å®¹**:
1. å…¨ã‚¸ãƒ§ãƒ–ã®çŠ¶æ…‹æƒ…å ±åé›†
2. æ¬¡å›å®Ÿè¡Œæ™‚åˆ»ã®å–å¾—ï¼ˆschedule.jobs æ¤œç´¢ï¼‰
3. ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ãƒªã‚¹ãƒˆã®ä½œæˆãƒ»è¿”å´

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def get_job_status(self) -> List[Dict[str, Any]]:
```

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| status_list | List[Dict[str, Any]] | å…¨ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ãƒªã‚¹ãƒˆ |

**æˆ»ã‚Šå€¤æ§‹é€ **:
```python
[{
    "name": str,              # ã‚¸ãƒ§ãƒ–å
    "enabled": bool,          # æœ‰åŠ¹ãƒ•ãƒ©ã‚°
    "schedule_type": str,     # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—
    "schedule_time": str,     # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»
    "last_run": str,          # æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»
    "last_status": str,       # æœ€çµ‚å®Ÿè¡ŒçŠ¶æ…‹
    "error_count": int,       # ã‚¨ãƒ©ãƒ¼å›æ•°
    "next_run": str           # æ¬¡å›å®Ÿè¡Œæ™‚åˆ»
}]
```

---

### _save_job_result(result)

**æ¦‚è¦**: ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæœä¿å­˜

**å‡¦ç†å†…å®¹**:
1. ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆãƒ»ç¢ºèª
2. æ—¥ä»˜åˆ¥JSONLãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
3. å®Ÿè¡Œçµæœã®JSONLå½¢å¼è¿½è¨˜ä¿å­˜
4. ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ã‚°å‡ºåŠ›

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def _save_job_result(self, result: BatchResult) -> None:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| result | BatchResult | â—‹ | ä¿å­˜å¯¾è±¡å®Ÿè¡Œçµæœ |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| ãªã— | None | çµæœä¿å­˜å®Œäº† |

**ä¿å­˜å…ˆ**: `./logs/batch/batch_YYYYMMDD.jsonl`

---

### create_cron_entry(job_name, schedule_time, python_path)

**æ¦‚è¦**: cronã‚¨ãƒ³ãƒˆãƒªç”Ÿæˆ

**å‡¦ç†å†…å®¹**:
1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹ã®å–å¾—
2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ã®cronå½¢å¼å¤‰æ›ï¼š
   - æ™‚åˆ»å½¢å¼ï¼ˆHH:MMï¼‰: æ—¥æ¬¡å®Ÿè¡Œ
   - æ•°å€¤å½¢å¼: é–“éš”å®Ÿè¡Œï¼ˆåˆ†å˜ä½å¤‰æ›ï¼‰
3. cronã‚¨ãƒ³ãƒˆãƒªæ–‡å­—åˆ—ã®ç”Ÿæˆãƒ»è¿”å´

**å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
def create_cron_entry(job_name: str, schedule_time: str, python_path: str = "python") -> str:
```

| å¼•æ•°å | å‹ | å¿…é ˆ | èª¬æ˜ |
|-------|---|------|------|
| job_name | str | â—‹ | ã‚¸ãƒ§ãƒ–å |
| schedule_time | str | â—‹ | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ» |
| python_path | str | Ã— | Pythonãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "python"ï¼‰ |

**å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
| æˆ»ã‚Šå€¤ | å‹ | èª¬æ˜ |
|-------|---|------|
| cron_entry | str | cronè¨­å®šã‚¨ãƒ³ãƒˆãƒª |

**ä½¿ç”¨ä¾‹**:
```python
entry = create_cron_entry("daily_analysis", "02:00")
print(entry)  # "0 2 * * * cd /path && python batch_runner.py run-job daily_analysis"
```

---

## ğŸ–¥ï¸ CLIæ©Ÿèƒ½ä»•æ§˜

### main()

**æ¦‚è¦**: ãƒ¡ã‚¤ãƒ³é–¢æ•°ãƒ»CLI ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

**å‡¦ç†å†…å®¹**:
1. ArgumentParser ã«ã‚ˆã‚‹å¼•æ•°è§£æãƒ»ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰å®šç¾©
2. ãƒ­ã‚°è¨­å®šãƒ»BatchRunner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
3. ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰åˆ†å²å‡¦ç†ãƒ»çµæœå‡ºåŠ›
4. ä¾‹å¤–å‡¦ç†ãƒ»çµ‚äº†ã‚³ãƒ¼ãƒ‰è¿”å´

**ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰**:
- `scheduler`: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼èµ·å‹•
- `run-job <job_name>`: ã‚¸ãƒ§ãƒ–å³æ™‚å®Ÿè¡Œ
- `list`: ã‚¸ãƒ§ãƒ–ä¸€è¦§è¡¨ç¤º
- `add <name> <command>`: ã‚¸ãƒ§ãƒ–è¿½åŠ 
- `remove <job_name>`: ã‚¸ãƒ§ãƒ–å‰Šé™¤
- `enable/disable <job_name>`: ã‚¸ãƒ§ãƒ–æœ‰åŠ¹/ç„¡åŠ¹åŒ–
- `cron <job_name>`: cronã‚¨ãƒ³ãƒˆãƒªç”Ÿæˆ

**å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³**:
- `--config, -c`: ãƒãƒƒãƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- `--log-level, -l`: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«

**ä½¿ç”¨ä¾‹**:
```bash
# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼èµ·å‹•
python batch_runner.py scheduler

# ã‚¸ãƒ§ãƒ–å³æ™‚å®Ÿè¡Œ
python batch_runner.py run-job daily_analysis

# ã‚¸ãƒ§ãƒ–ä¸€è¦§è¡¨ç¤º
python batch_runner.py list

# ã‚¸ãƒ§ãƒ–è¿½åŠ 
python batch_runner.py add backup_task "python backup.py" --type daily --time "03:00"

# cronã‚¨ãƒ³ãƒˆãƒªç”Ÿæˆ
python batch_runner.py cron daily_analysis
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### BatchJob

**æ¦‚è¦**: ãƒãƒƒãƒã‚¸ãƒ§ãƒ–å®šç¾©

**å±æ€§**:
| å±æ€§å | å‹ | èª¬æ˜ |
|-------|---|------|
| name | str | ã‚¸ãƒ§ãƒ–åï¼ˆä¸€æ„è­˜åˆ¥å­ï¼‰ |
| command | str | å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ |
| schedule_type | str | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ï¼ˆinterval/daily/weeklyï¼‰ |
| schedule_time | str | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ï¼ˆ"10:30"/"60"/"sunday"ï¼‰ |
| enabled | bool | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| last_run | Optional[str] | æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰ |
| last_status | Optional[str] | æœ€çµ‚å®Ÿè¡ŒçŠ¶æ…‹ |
| error_count | int | ã‚¨ãƒ©ãƒ¼å›æ•° |

### BatchResult

**æ¦‚è¦**: ãƒãƒƒãƒå®Ÿè¡Œçµæœ

**å±æ€§**:
| å±æ€§å | å‹ | èª¬æ˜ |
|-------|---|------|
| job_name | str | ã‚¸ãƒ§ãƒ–å |
| start_time | str | å®Ÿè¡Œé–‹å§‹æ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰ |
| end_time | str | å®Ÿè¡Œçµ‚äº†æ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰ |
| status | str | å®Ÿè¡ŒçŠ¶æ…‹ï¼ˆsuccess/error/timeoutï¼‰ |
| output | str | æ¨™æº–å‡ºåŠ› |
| error | Optional[str] | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |

---

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
```
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼èµ·å‹•
   â†“
è¨­å®šèª­ã¿è¾¼ã¿ãƒ»ã‚¸ãƒ§ãƒ–ç™»éŒ²
   â†“
å…¨ã‚¸ãƒ§ãƒ–ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
   â”œâ”€ interval: ç§’é–“éš”å®Ÿè¡Œ
   â”œâ”€ daily: æŒ‡å®šæ™‚åˆ»å®Ÿè¡Œ
   â””â”€ weekly: æŒ‡å®šæ›œæ—¥å®Ÿè¡Œ
   â†“
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—ï¼ˆ1ç§’é–“éš”ï¼‰
   â”œâ”€ schedule.run_pending()
   â”œâ”€ å®Ÿè¡Œå¯¾è±¡ã‚¸ãƒ§ãƒ–ã®æ¤œå‡º
   â””â”€ ã‚¸ãƒ§ãƒ–å®Ÿè¡Œãƒ»çµæœè¨˜éŒ²
   â†“
ã‚·ã‚°ãƒŠãƒ«å—ä¿¡æ™‚ã®çµ‚äº†å‡¦ç†
```

### ã‚¸ãƒ§ãƒ–å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
```
ã‚¸ãƒ§ãƒ–å®Ÿè¡Œé–‹å§‹
   â†“
BatchResultåˆæœŸåŒ–ãƒ»é–‹å§‹æ™‚åˆ»è¨˜éŒ²
   â†“
subprocess ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
   â”œâ”€ æ¨™æº–å‡ºåŠ›ãƒ»ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚­ãƒ£ãƒ—ãƒãƒ£
   â”œâ”€ 30åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
   â””â”€ æˆ»ã‚Šå€¤ãƒã‚§ãƒƒã‚¯
   â†“
å®Ÿè¡Œçµæœåˆ¤å®š
   â”œâ”€ æˆ»ã‚Šå€¤0: success
   â”œâ”€ æˆ»ã‚Šå€¤é0: error
   â””â”€ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: timeout
   â†“
ã‚¸ãƒ§ãƒ–çŠ¶æ…‹æ›´æ–°ãƒ»çµæœä¿å­˜
   â”œâ”€ ã‚¨ãƒ©ãƒ¼å›æ•°æ›´æ–°
   â”œâ”€ æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»è¨˜éŒ²
   â”œâ”€ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
   â””â”€ JSONLãƒ­ã‚°å‡ºåŠ›
   â†“
é€£ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥å‡¦ç†ï¼ˆ3å›ä»¥ä¸Šï¼‰
```

### ã‚¸ãƒ§ãƒ–ç®¡ç†ãƒ•ãƒ­ãƒ¼
```
CLI ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
   â†“
å¼•æ•°è§£æãƒ»ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰åˆ†å²
   â”œâ”€ add: ã‚¸ãƒ§ãƒ–è¿½åŠ ãƒ»è¨­å®šä¿å­˜
   â”œâ”€ remove: ã‚¸ãƒ§ãƒ–å‰Šé™¤ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤
   â”œâ”€ enable/disable: æœ‰åŠ¹æ€§å¤‰æ›´ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°
   â”œâ”€ list: ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ä¸€è¦§è¡¨ç¤º
   â”œâ”€ run-job: å³æ™‚å®Ÿè¡Œãƒ»çµæœè¡¨ç¤º
   â””â”€ cron: cronã‚¨ãƒ³ãƒˆãƒªç”Ÿæˆ
   â†“
å®Ÿè¡Œçµæœãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›
   â†“
çµ‚äº†ã‚³ãƒ¼ãƒ‰è¿”å´
```

---

## âš™ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä»•æ§˜

### batch_config.json æ§‹é€ 
```json
{
  "jobs": [
    {
      "name": "hourly_detection",
      "command": "python main.py --mode single",
      "schedule_type": "interval",
      "schedule_time": "3600",
      "enabled": true,
      "last_run": null,
      "last_status": null,
      "error_count": 0
    },
    {
      "name": "daily_analysis",
      "command": "python main.py --mode analysis",
      "schedule_type": "daily",
      "schedule_time": "02:00",
      "enabled": true,
      "last_run": null,
      "last_status": null,
      "error_count": 0
    }
  ]
}
```

### ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä»•æ§˜

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `./logs/batch/batch_YYYYMMDD.jsonl`  
**å½¢å¼**: JSONLï¼ˆ1è¡Œ1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®JSONï¼‰

**ãƒ¬ã‚³ãƒ¼ãƒ‰ä¾‹**:
```json
{"job_name": "daily_analysis", "start_time": "2025-07-29T02:00:00", "end_time": "2025-07-29T02:05:30", "status": "success", "output": "Analysis completed successfully", "error": null}
```

---

## ğŸ”— å¤–éƒ¨é€£æºæ©Ÿèƒ½

### cron çµ±åˆ
```bash
# ç”Ÿæˆã•ã‚ŒãŸcronã‚¨ãƒ³ãƒˆãƒªã®ä¾‹
0 2 * * * cd /path/to/project && python batch_runner.py run-job daily_analysis
*/60 * * * * cd /path/to/project && python batch_runner.py run-job hourly_detection
```

### systemd çµ±åˆ
```ini
[Unit]
Description=Insect Observer Batch Scheduler
After=multi-user.target

[Service]
Type=simple
ExecStart=/usr/bin/python3 /path/to/batch_runner.py scheduler
Restart=always
User=observer

[Install]
WantedBy=multi-user.target
```

---

## ğŸ“ å®Ÿè£…ãƒ¡ãƒ¢

### æ³¨æ„äº‹é …
- subprocess ã«ã‚ˆã‚‹å®‰å…¨ãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
- ã‚¸ãƒ§ãƒ–ä¸¦åˆ—å®Ÿè¡Œæ™‚ã®ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆå›é¿
- ã‚¨ãƒ©ãƒ¼å›æ•°åˆ¶é™ãƒ»é€šçŸ¥æ©Ÿèƒ½ã«ã‚ˆã‚‹éšœå®³å¯¾å¿œ
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®é©åˆ‡ãªç®¡ç†

### ä¾å­˜é–¢ä¿‚
- schedule: Pythonã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- subprocess: å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
- argparse: CLIå¼•æ•°è§£æ
- threading: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰ç®¡ç†
- pathlib: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹æ“ä½œ

---

## ğŸ”„ æ›´æ–°å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ›´æ–°æ—¥ | æ›´æ–°è€… | æ›´æ–°å†…å®¹ |
|-----------|--------|--------|----------|
| 1.0 | 2025-07-29 | é–‹ç™ºãƒãƒ¼ãƒ  | åˆç‰ˆä½œæˆ |